#!/usr/bin/env bash
if [[ $# -ne 1 ]]; then
  echo "No args set!"
  exit 1
fi
mirror_name=$1
date=$(date +%s)
# update ${mirror_name} mirror
/usr/bin/aptly mirror update ${mirror_name}
# create new snapshot for ${mirror_name} mirror
/usr/bin/aptly snapshot create ${mirror_name}-main-${date} from mirror ${mirror_name}
/usr/bin/aptly snapshot create ${mirror_name}-contrib-${date} from mirror ${mirror_name}
/usr/bin/aptly snapshot create ${mirror_name}-nonfree-${date} from mirror ${mirror_name}

# check if aptly has already published this mirror
/usr/bin/aptly publish list | grep -q "${mirror_name}"
if [[ $? -ne 0 ]]; then
  /usr/bin/aptly publish snapshot -passphrase="<%= @gpg_pass -%>" -batch=true -component=non-free,main,contrib ${mirror_name}-nonfree-${date} ${mirror_name}-main-${date} ${mirror_name}-contrib-${date}
else
  /usr/bin/aptly publish switch -passphrase="<%= @gpg_pass -%>" -batch=true -component=non-free,main,contrib ${mirror_name} ${mirror_name}-nonfree-${date} ${mirror_name}-main-${date} ${mirror_name}-contrib-${date}
fi
